<html><head>
	<meta charset='utf-8'>
	<title>A岛文豪@OpenDanmaku磁链弹幕</title>
	<link rel="Shortcut Icon" href="src/16x16t.ico"><!--	local image	-->

</head>
<body>
<div>Ａ岛文豪更新,关岛仍然有效!<br></div>
<div id="ad" style="background:#FFEFEF; color:#800000" onclick="ShowAD();">
	磁链弹幕OpenDanmaku项目诚邀志同道合者,<b>详情请点击</b>
</div>
<div id="mainFloor" style="background:#FFD0D0; color:#800000"></div><br />
<div id="replyFloor" style="background:#FFEFEF; color:#800000"></div>
<script type="text/javascript">
//正文
	//全局变量
	Page_JSON=new Array()
	Page_ID=0;
	getLoop=0;
	maxLoop=0;
	x=-1;
	MainFloor=new Object()
	UID="";
	maxLength=80;//默认多于80字符的也显示,除非给两个参数,或者唯一的参数不是主楼

	//获取页面ID或回复ID
	para=document.URL.split("=");
	paraLength=para.length;
	if (paraLength==2)maxLength=65535;//除非给两个参数,即都为主楼,或一个主楼一个回复
	var rid=parseInt(para.pop().replace(/[^0-9]/ig,""));
	if (isNaN(rid)){
		ShowInstruction();
	}else{
	var src_rid="http://h.acfun.tv/api/t/" + rid.toString() + "?callback=getRid";

	//获取此条JSON,回调getRid
	var JSONP=document.createElement("script");
		JSONP.type="text/javascript";
		JSONP.src=src_rid;
		document.body.appendChild(JSONP);
	}
//正文结束

	function ShowInstruction(){
		//功能提示
		var Instruction="<br><br>想要欣赏某文豪发的全文却感到麻烦重重？<br>想要找到某个人的全部点评却觉大海捞针？<br>";
		Instruction+="再也不会了！<br>只要在页面链接前加<br>　　　　http://opendanmaku.github.io/#<br>";
		Instruction+="即可阅读此饼干的全部回复！<br><br>";
		Instruction+="<font color=\"#789922\">&gt;&gt;解析规则更新啦！<b>支持图片的显示和缩放！支持图片精选！</b><br>";
		Instruction+="&gt;&gt;范例：</font><br>PO文去水（PO，超过80字符的回复,含有图片的回复，适用于PO更换饼干）<br>";
		Instruction+="http://opendanmaku.github.io/#http://h.acfun.tv/t/4705755<br>";
		Instruction+="http://opendanmaku.github.io/#4705755<br><br>";
		Instruction+="只看PO主（只有PO，适用于PO没换饼干）<br>";
		Instruction+="http://opendanmaku.github.io/#http://h.acfun.tv/t/4705755?r=4705755<br><br>";
		Instruction+="只看此楼作者全部评论（适用于查看点评，或者作者某曾用Cookie的发言）";
		Instruction+="<br>http://opendanmaku.github.io/#http://h.acfun.tv/t/4705755?r=5253756<br>";
		Instruction+="http://opendanmaku.github.io/#5253756<br><br>";
		Instruction+="<font color=\"#789922\">&gt;&gt;请大家支持、推广、转发OpenDanmaku磁链弹幕项目！<br>";
		Instruction+="&gt;&gt;项目地址&nbsp;https://github.com/opendanmaku/opendanmaku/<br>";
		Instruction+="&gt;&gt;欢迎编程爱好者参与项目！感谢大家！(ノ???)ノ</font><br>";	

		document.getElementById("ad").innerHTML+=Instruction;
	}

	function ShowAD(){
		//项目广告
		var MyAD=" 磁链弹幕OpenDanmaku项目诚邀志同道合者 <br>";
		MyAD+="用途<br>　　　　提供一个按磁力链接索引的匿名弹幕服务器,以及相应的API,平台为新浪云<br>";
		MyAD+="　　　　只要你提供magnet链接(中的btih编码),你可以借此在任何视频中分享弹幕<br>";
		MyAD+="　　　　没错,任何视频,能干什么你懂的<br>";
		MyAD+="功能<br>　　　　获取用户Cookie:并且有积分和操作硬直设定<br>";
		MyAD+="　　　　新建/获取视频信息:最近一周的最热视频,最近一周投稿(时间倒序),某投稿信息<br>";
		MyAD+="　　　　新建/获取弹幕信息:按序号/时间获取,获取最后x条弹幕,获取最新弹幕,获取全部弹幕<br>";
		MyAD+="　　　　新建/获取交叉链接:允许不同压制格式,不同字幕组,或合集与单集之间相互共享弹幕<br>";
		MyAD+="　　　　新建/获取云屏蔽:被dislike的弹幕可以隐藏,被dislike的人耗尽积分后会被禁言<br>";
		MyAD+="　　　　<b>详见&nbsp;<a href=\"https://github.com/OpenDanmaku/OpenDanmaku/\">https://github.com/OpenDanmaku/OpenDanmaku/</a></b><br>";
		MyAD+="状态<br>　　　　服务器端勉强写完了,因为是初学php,里面还存在大量的语法错误,<br>";
		MyAD+="　　　　不优雅不简洁和漏洞,但是代码大致可以解释清楚功能<br>";
		MyAD+="　　　　播放页预计将借用jabbany氏的ABPlayerHTML5/CommentCoreLibrary,<br>";
		MyAD+="　　　　他的优秀作品甚至被a站html5播放器引用,谨表致意<br>";
		MyAD+="　　　　在下不是专业学计算机和软件的,虽然有个小点子,<br>";
		MyAD+="　　　　但是实践起来很苦手,项目整体还是未完成状态<br>";
		MyAD+="　　　　如果有哪位感兴趣,欢迎加入OpenDanmaku小组,或者来fork代码,或者联系我schezuk@163.com<br>";
		MyAD+="未来<br>　　　　理论上,我们可以实现一种弱中心的分布式匿名弹幕网络<br>";
		MyAD+="　　　　借由与bt或magnet或ed2k绑定的分布式IRC(或插件),<br>";
		MyAD+="　　　　利用这些协议现有的,或者自己设计的单独的聊天信道交换弹幕报文<br>";
		MyAD+="　　　　仍然可以实现云屏蔽(用户对某条弹幕/某人标记dislike),跨弹幕池引用等等<br>";
		MyAD+="　　　　专门的服务器提供分布式数据库储存,互相保持最终一致性,平时主要访问这个渠道<br>";
		MyAD+="　　　　如果服务器不能访问,每个客户端也可以牺牲效率,直接互相同步弹幕<br>";
		MyAD+="　　　　客户端监听每个anonymous&nbsp;user发布弹幕时的广播,互相传递本地弹幕cache,并用guid来去除重复<br>";
		MyAD+="　　　　<b>如果有哪位大神能来合作实现,不胜感激,请务必联系我<a href=\"mailto:schezuk@163.com\">schezuk@163.com</a></b>";

		document.getElementById("ad").innerHTML=MyAD;
	}

	function getRid(data){
		//获取显示的uid
		UID=data.threads.uid;
		//获取父页面ID
		Page_ID=data.threads.parent;
		if(data.threads.parent==0) Page_ID=data.threads.id;
		else if (paraLength==1) maxLength=65535;//参数唯一且parent不为0,即唯一的参数不是主楼
		//获取父页面JSON,回调getParent
		var src_parent="http://h.acfun.tv/api/t/" + Page_ID.toString() + "?callback=getParent";
		var JSONP=document.createElement("script");
			JSONP.type="text/javascript";
			JSONP.src=src_parent;
		document.body.appendChild(JSONP);
	}
	
	function getParent(data){
		//获取主楼
		MainFloor=data.threads;
		//获取循环次数,标记第一次循环
		maxLoop=data.page.size;//alert(maxLoop);
		getLoop=1;
		//获取第一个循环页面,回调getJSON
		var src_parent="http://h.acfun.tv/api/t/" + Page_ID.toString() + "?page=" + getLoop.toString() + "&callback=getJSON";
		var JSONP=document.createElement("script");
			JSONP.type="text/javascript";
			JSONP.src=src_parent;
		document.body.appendChild(JSONP);
	
	}
	function getJSON(data){
		//合并JSON
		//alert(typeof(data.replys));
		Page_JSON=Page_JSON.concat(data.replys);
		//合并完成,循环数自增1
		++getLoop;//alert(getLoop);
		if(getLoop<=maxLoop){//当循环小于等于上界,递归
			var src_parent="http://h.acfun.tv/api/t/" + Page_ID.toString() + "?page=" + getLoop.toString() + "&callback=getJSON";
			var JSONP=document.createElement("script");
				JSONP.type="text/javascript";
				JSONP.src=src_parent;
			document.body.appendChild(JSONP);
		}else{//当循环到达上界
			printJSON();
		}
	}
	function printJSON(){
		//alert(Page_JSON);
		//alert(Page_JSON.length);
		document.getElementById("mainFloor").innerHTML=printFloor(MainFloor);
		document.getElementById("replyFloor").innerHTML+=printReply();
	}
	function printFloor(data){
		var str="";
		var url="http://static.acfun.mm111.net/h/"
		str+="<b>"+emptyTitle(data.title)+" "+emptyName(data.name)+" "+data.email+" </b>"+dateTotime(data.createdAt)+" <b>ID:"+data.uid.toString()
		str+=" "+" </b>No.<b>"+data.id+"</b> Page "+(Math.floor(x/20)+1)+"<br/>"+data.content+"<br>"
		if(data.image!="") str+="<img style=\"width: 250px\" src=\"" + url+data.image + "\" onclick=\"resize(this.id);\" id=\"" + x + "\" /><br>";
		return str;
	}
	function printReply(){
	var str="";
	for (x in Page_JSON){
		var this_JSON=Page_JSON[x];
		if(this_JSON.uid==UID) str+=printFloor(this_JSON);
		else {
			if(this_JSON.content.length>maxLength) str+=printFloor(this_JSON);
			else if (maxLength ==80 && typeof(this_JSON.image)!="undefined" && this_JSON.image!="") str+=printFloor(this_JSON);
		}
	}
	return str;
	}
	function dateTotime(date_time)
{

		var timestr = new Date(parseInt(date_time));

		return timestr.toLocaleString().replace(/\//g, "-");

	}
	function emptyTitle(data){return (data==""?"无标题":data);}
	function emptyName (data){return (data==""?"无名氏":data);}
	function resize(data){
		var this_width=document.getElementById(data.toString()).style.width;
		//alert(typeof(this_width));alert(this_width);
		if (this_width=="250px") document.getElementById(data.toString()).style.width="100%";
		else document.getElementById(data.toString()).style.width="250px";
	}
</script>
<script type="text/javascript" id="tc_3c6b1ff9a8">
var _tcq = _tcq || []; _tcq.push(['flag', '3c6b1ff9a8', '000000', 'ffffff', 'ffffff', '1', '1', '0']); 
(function() { var e = document.createElement('script'); e.type = 'text/javascript'; e.async = true; e.src = '//s.tcimg.com/w/v2/flag.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(e, s); })();
</script>
</body>
</html>
